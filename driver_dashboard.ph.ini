<?php
session_start();
include 'db_connect.php';

// டிரைவர் லாகின் செய்துள்ளாரா என்று செக் செய்தல்
if (!isset($_SESSION['driver_id']) || $_SESSION['role'] != 'driver') {
    header("Location: index.php");
    exit();
}

$driver_id = $_SESSION['driver_id'];
$driver_name = $_SESSION['name'];

// டிரைவரின் ஊரை (City) கண்டுபிடித்தல் (City Matching-க்காக)
$driver_sql = "SELECT city FROM drivers WHERE id='$driver_id'";
$driver_result = $conn->query($driver_sql);
$driver_row = $driver_result->fetch_assoc();
$driver_city = $driver_row['city'];

// 1. Accept அல்லது Decline பட்டன் அழுத்தினால் நடக்கும் செயல்
if (isset($_GET['action']) && isset($_GET['id'])) {
    $booking_id = $_GET['id'];
    $action = $_GET['action'];

    if ($action == 'accept') {
        // டிரைவர் ஐடியை அந்த புக்கிங்கில் அப்டேட் செய்தல்
        $update_sql = "UPDATE bookings SET driver_id='$driver_id', booking_status='Accepted' WHERE booking_id='$booking_id'";
    } elseif ($action == 'decline') {
        $update_sql = "UPDATE bookings SET booking_status='Cancelled' WHERE booking_id='$booking_id'";
    }

    if ($conn->query($update_sql) === TRUE) {
        echo "<script>alert('Booking Status Updated!'); window.location='driver_dashboard.php';</script>";
    } else {
        echo "Error updating record: " . $conn->error;
    }
}
?>

<!DOCTYPE html>
<html>
<head>
    <title>Driver Dashboard</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .container { display: flex; flex-direction: column; gap: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }
        .btn-accept { background-color: green; color: white; padding: 5px 10px; text-decoration: none; border-radius: 4px; }
        .btn-decline { background-color: red; color: white; padding: 5px 10px; text-decoration: none; border-radius: 4px; margin-left: 5px; }
        .section { border: 1px solid #ccc; padding: 20px; background: #fff; }
    </style>
</head>
<body>

    <h2>Welcome Driver, <?php echo $driver_name; ?>! (City: <?php echo $driver_city; ?>) 
        <a href="index.php" style="float:right; font-size:16px;">Logout</a>
    </h2>
    <hr>

    <div class="container">
        
        <div class="section">
            <h3 style="color:blue;">New Booking Requests (In your City)</h3>
            <table>
                <tr>
                    <th>Trip Date</th>
                    <th>Pickup Area</th>
                    <th>Car Model</th>
                    <th>Trip Type</th>
                    <th>Amount</th>
                    <th>Action</th>
                </tr>
                <?php
                // டிரைவரின் ஊரில் உள்ள, இன்னும் யாரும் எடுக்காத (Pending) புக்கிங் மட்டும் காட்டும்
                $sql = "SELECT * FROM bookings WHERE pickup_city='$driver_city' AND booking_status='Pending'";
                $result = $conn->query($sql);

                if ($result->num_rows > 0) {
                    while($row = $result->fetch_assoc()) {
                        echo "<tr>";
                        echo "<td>" . $row['trip_date'] . "</td>";
                        echo "<td>" . $row['pickup_address'] . "</td>";
                        echo "<td>" . $row['car_type'] . "</td>";
                        echo "<td>" . $row['trip_type'] . "</td>";
                        echo "<td>Rs. " . $row['amount'] . "</td>";
                        echo "<td>
                                <a href='driver_dashboard.php?action=accept&id=".$row['booking_id']."' class='btn-accept'>Accept</a>
                                <a href='driver_dashboard.php?action=decline&id=".$row['booking_id']."' class='btn-decline'>Decline</a>
                              </td>";
                        echo "</tr>";
                    }
                } else {
                    echo "<tr><td colspan='6'>No new requests in your city.</td></tr>";
                }
                ?>
            </table>
        </div>

        <div class="section">
            <h3 style="color:green;">My Upcoming Trips (Customer Details)</h3>
            <table>
                <tr>
                    <th>Trip Date</th>
                    <th>Customer Name</th>
                    <th>Mobile</th>
                    <th>Pickup</th>
                    <th>Drop</th>
                    <th>Status</th>
                    <th>Payment</th>
                </tr>
                <?php
                // இந்த டிரைவர் ஒப்புக்கொண்ட சவாரிகள் மற்றும் யூசர் விவரங்களை இணைத்து (JOIN) எடுத்தல்
                $my_trips_sql = "SELECT b.*, u.name as user_name, u.mobile as user_mobile 
                                 FROM bookings b 
                                 JOIN users u ON b.user_id = u.id 
                                 WHERE b.driver_id='$driver_id' ORDER BY b.trip_date DESC";
                $my_result = $conn->query($my_trips_sql);

                if ($my_result->num_rows > 0) {
                    while($row = $my_result->fetch_assoc()) {
                        echo "<tr>";
                        echo "<td>" . $row['trip_date'] . "</td>";
                        echo "<td>" . $row['user_name'] . "</td>";
                        echo "<td>" . $row['user_mobile'] . "</td>"; // இப்போது தான் மொபைல் நம்பர் தெரியும்
                        echo "<td>" . $row['pickup_address'] . "</td>";
                        echo "<td>" . $row['drop_address'] . "</td>";
                        echo "<td>" . $row['booking_status'] . "</td>";
                        
                        // Payment Status காட்டுதல்
                        if($row['payment_status'] == 'Paid') {
                            echo "<td style='color:green; font-weight:bold;'>Paid</td>";
                        } else {
                            echo "<td style='color:red;'>Pending</td>";
                        }
                        echo "</tr>";
                    }
                } else {
                    echo "<tr><td colspan='7'>You haven't accepted any trips yet.</td></tr>";
                }
                ?>
            </table>
        </div>

    </div>

</body>
</html>